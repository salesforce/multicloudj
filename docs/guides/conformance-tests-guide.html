<!DOCTYPE html> <html lang="en-US"> <head> <meta charset="UTF-8"> <meta http-equiv="X-UA-Compatible" content="IE=Edge"> <link rel="stylesheet" href="/multicloudj/assets/css/just-the-docs-default.css"> <link rel="stylesheet" href="/multicloudj/assets/css/just-the-docs-head-nav.css" id="jtd-head-nav-stylesheet"> <style id="jtd-nav-activation"> .site-nav ul li a { background-image: none; } </style> <script src="/multicloudj/assets/js/vendor/lunr.min.js"></script> <script src="/multicloudj/assets/js/just-the-docs.js"></script> <meta name="viewport" content="width=device-width, initial-scale=1"> <!-- Begin Jekyll SEO tag v2.8.0 --> <title>How to: Conformance tests in multicloudj | MulticloudJ</title> <meta name="generator" content="Jekyll v4.4.1" /> <meta property="og:title" content="How to: Conformance tests in multicloudj" /> <meta property="og:locale" content="en_US" /> <meta name="description" content="Substrate Agnostic Cloud SDK for Java" /> <meta property="og:description" content="Substrate Agnostic Cloud SDK for Java" /> <link rel="canonical" href="https://opensource.salesforce.com/multicloudj/guides/conformance-tests-guide.html" /> <meta property="og:url" content="https://opensource.salesforce.com/multicloudj/guides/conformance-tests-guide.html" /> <meta property="og:site_name" content="MulticloudJ" /> <meta property="og:type" content="website" /> <meta name="twitter:card" content="summary" /> <meta property="twitter:title" content="How to: Conformance tests in multicloudj" /> <script type="application/ld+json"> {"@context":"https://schema.org","@type":"WebPage","description":"Substrate Agnostic Cloud SDK for Java","headline":"How to: Conformance tests in multicloudj","url":"https://opensource.salesforce.com/multicloudj/guides/conformance-tests-guide.html"}</script> <!-- End Jekyll SEO tag --> </head> <body> <a class="skip-to-main" href="#main-content">Skip to main content</a> <svg xmlns="http://www.w3.org/2000/svg" class="d-none"> <symbol id="svg-link" viewBox="0 0 24 24"> <title>Link</title> <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-link"> <path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"></path><path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"></path> </svg> </symbol> <symbol id="svg-menu" viewBox="0 0 24 24"> <title>Menu</title> <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-menu"> <line x1="3" y1="12" x2="21" y2="12"></line><line x1="3" y1="6" x2="21" y2="6"></line><line x1="3" y1="18" x2="21" y2="18"></line> </svg> </symbol> <symbol id="svg-arrow-right" viewBox="0 0 24 24"> <title>Expand</title> <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-chevron-right"> <polyline points="9 18 15 12 9 6"></polyline> </svg> </symbol> <!-- Feather. MIT License: https://github.com/feathericons/feather/blob/master/LICENSE --> <symbol id="svg-external-link" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-external-link"> <title id="svg-external-link-title">(external link)</title> <path d="M18 13v6a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h6"></path><polyline points="15 3 21 3 21 9"></polyline><line x1="10" y1="14" x2="21" y2="3"></line> </symbol> <symbol id="svg-doc" viewBox="0 0 24 24"> <title>Document</title> <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-file"> <path d="M13 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V9z"></path><polyline points="13 2 13 9 20 9"></polyline> </svg> </symbol> <symbol id="svg-search" viewBox="0 0 24 24"> <title>Search</title> <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-search"> <circle cx="11" cy="11" r="8"></circle><line x1="21" y1="21" x2="16.65" y2="16.65"></line> </svg> </symbol> <!-- Bootstrap Icons. MIT License: https://github.com/twbs/icons/blob/main/LICENSE.md --> <symbol id="svg-copy" viewBox="0 0 16 16"> <title>Copy</title> <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-clipboard" viewBox="0 0 16 16"> <path d="M4 1.5H3a2 2 0 0 0-2 2V14a2 2 0 0 0 2 2h10a2 2 0 0 0 2-2V3.5a2 2 0 0 0-2-2h-1v1h1a1 1 0 0 1 1 1V14a1 1 0 0 1-1 1H3a1 1 0 0 1-1-1V3.5a1 1 0 0 1 1-1h1v-1z"/> <path d="M9.5 1a.5.5 0 0 1 .5.5v1a.5.5 0 0 1-.5.5h-3a.5.5 0 0 1-.5-.5v-1a.5.5 0 0 1 .5-.5h3zm-3-1A1.5 1.5 0 0 0 5 1.5v1A1.5 1.5 0 0 0 6.5 4h3A1.5 1.5 0 0 0 11 2.5v-1A1.5 1.5 0 0 0 9.5 0h-3z"/> </svg> </symbol> <symbol id="svg-copied" viewBox="0 0 16 16"> <title>Copied</title> <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-clipboard-check-fill" viewBox="0 0 16 16"> <path d="M6.5 0A1.5 1.5 0 0 0 5 1.5v1A1.5 1.5 0 0 0 6.5 4h3A1.5 1.5 0 0 0 11 2.5v-1A1.5 1.5 0 0 0 9.5 0h-3Zm3 1a.5.5 0 0 1 .5.5v1a.5.5 0 0 1-.5.5h-3a.5.5 0 0 1-.5-.5v-1a.5.5 0 0 1 .5-.5h3Z"/> <path d="M4 1.5H3a2 2 0 0 0-2 2V14a2 2 0 0 0 2 2h10a2 2 0 0 0 2-2V3.5a2 2 0 0 0-2-2h-1v1A2.5 2.5 0 0 1 9.5 5h-3A2.5 2.5 0 0 1 4 2.5v-1Zm6.854 7.354-3 3a.5.5 0 0 1-.708 0l-1.5-1.5a.5.5 0 0 1 .708-.708L7.5 10.793l2.646-2.647a.5.5 0 0 1 .708.708Z"/> </svg> </symbol> </svg> <div class="side-bar"> <div class="site-header" role="banner"> <a href="/multicloudj/" class="site-title lh-tight"> MulticloudJ </a> <button id="menu-button" class="site-button btn-reset" aria-label="Toggle menu" aria-pressed="false"> <svg viewBox="0 0 24 24" class="icon" aria-hidden="true"><use xlink:href="#svg-menu"></use></svg> </button> </div> <nav aria-label="Main" id="site-nav" class="site-nav"> <ul class="nav-list"><li class="nav-list-item"><a href="/multicloudj/" class="nav-list-link">MultiCloudJ Overview</a></li><li class="nav-list-item"><button class="nav-list-expander btn-reset" aria-label="toggle items in Usage Guides category" aria-pressed="false"> <svg viewBox="0 0 24 24" aria-hidden="true"><use xlink:href="#svg-arrow-right"></use></svg> </button><a href="/multicloudj/guides/" class="nav-list-link">Usage Guides</a><ul class="nav-list"><li class="nav-list-item"><a href="/multicloudj/guides/sts-guide.html" class="nav-list-link">How to STS</a></li><li class="nav-list-item"><a href="/multicloudj/guides/blobstore-guide.html" class="nav-list-link">How to Blob store</a></li><li class="nav-list-item"><a href="/multicloudj/guides/docstore-guide.html" class="nav-list-link">How to Docstore</a></li></ul></li><li class="nav-list-item"><button class="nav-list-expander btn-reset" aria-label="toggle items in Design category" aria-pressed="false"> <svg viewBox="0 0 24 24" aria-hidden="true"><use xlink:href="#svg-arrow-right"></use></svg> </button><a href="/multicloudj/design/" class="nav-list-link">Design</a><ul class="nav-list"><li class="nav-list-item"><a href="/multicloudj/design/layers.html" class="nav-list-link">Layers</a></li><li class="nav-list-item"><a href="/multicloudj/design/flexibility.html" class="nav-list-link">Flexibility</a></li><li class="nav-list-item"><a href="/multicloudj/design/errors.html" class="nav-list-link">Exception Handling</a></li></ul></li><li class="nav-list-item"><a href="/multicloudj/api-java-doc.html" class="nav-list-link">Api Documentation</a></li></ul> </nav> <hr> <p style="text-align: center; font-size: 0.8rem; color: #aaa;"> This site if maintained by the MulticloudJ team. </p> </div> <div class="main" id="top"> <div id="main-header" class="main-header"> <div class="search" role="search"> <div class="search-input-wrap"> <input type="text" id="search-input" class="search-input" tabindex="0" placeholder="Search MulticloudJ" aria-label="Search MulticloudJ" autocomplete="off"> <label for="search-input" class="search-label"><svg viewBox="0 0 24 24" class="search-icon"><use xlink:href="#svg-search"></use></svg></label> </div> <div id="search-results" class="search-results"></div> </div> </div> <div class="main-content-wrap"> <nav aria-label="Breadcrumb" class="breadcrumb-nav"> <ol class="breadcrumb-nav-list"> <li class="breadcrumb-nav-list-item"><span>How to: Conformance tests in multicloudj</span></li> </ol> </nav> <div id="main-content" class="main-content"> <main> <h1 id="how-to-conformance-tests-in-multicloud"> <a href="#how-to-conformance-tests-in-multicloud" class="anchor-heading" aria-labelledby="how-to-conformance-tests-in-multicloud"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> How to: Conformance tests in multicloud </h1> <p>This document is to help you write the conformance tests (can be aka integration tests) for multicloudj using wiremock to record and replay the cloud service calls.</p> <h2 id="overview"> <a href="#overview" class="anchor-heading" aria-labelledby="overview"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Overview </h2> <p>Conformance tests are very powerful to validate the SDK for multi-cloud environments where all the provider implementation satisfy the common abstractions.</p> <ul> <li>Conformance tests are written once at the abstract level and all the provider implementations supply the substrate specific details such as resource names to execute the tests for that cloud provider.</li> <li>Conformance tests can be executed in the offline mode where itâ€™s challenging to get real time network connectivity from a single source to multiple cloud providers.</li> </ul> <p>Conformance tests can run in two modes:</p> <ol> <li><strong>Record mode</strong>: where the tests hit the real service endpoint and transactions get intercepted by proxy and recorded in the files.</li> <li><strong>Replay mode</strong>: where the tests get the replayed responses from the previously recorded transactions.</li> </ol> <p><img src="conformance.png" alt="Conformance Tests Architecture" /></p> <h2 id="wiremock-as-a-forward-proxy"> <a href="#wiremock-as-a-forward-proxy" class="anchor-heading" aria-labelledby="wiremock-as-a-forward-proxy"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Wiremock as a forward proxy </h2> <p>To intercept the tests in record mode, we use wiremock server as forward proxy which has the ability the record the transactions and replay it later.</p> <p>SDK client to wiremock doesnâ€™t matter much for security because everything is local, therefore we configure the SDK clients to trust all the certs which includes the wiremock self signed cert presented to the SDK client. We can also have that layer to http as well.</p> <h2 id="how-to-configure-the-sdk-to-proxy-through-wiremock"> <a href="#how-to-configure-the-sdk-to-proxy-through-wiremock" class="anchor-heading" aria-labelledby="how-to-configure-the-sdk-to-proxy-through-wiremock"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> How to configure the SDK to proxy through wiremock </h2> <p>In order to utilize the record/replay mode through wiremock there are two most common ways provide the SDKs:</p> <h3 id="override-the-http-client-in-sdk-preferred"> <a href="#override-the-http-client-in-sdk-preferred" class="anchor-heading" aria-labelledby="override-the-http-client-in-sdk-preferred"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Override the http client in SDK (preferred) </h3> <p>You should be able to override the http client in SDK client and your http client should have the proxy configured to wiremock.</p> <p><strong>AWS example:</strong> You can create the custom http client for AWS (<a href="https://github.com/salesforce/multicloudj/blob/584f577efd62ecb8f8308cc21c935cc8e0a3c260/docstore/docstore-aws/src/test/java/com/salesforce/multicloudj/docstore/aws/AwsDocstoreIT.java#L33">code ref</a>) and inject in into the SDK client.</p> <p><strong>Ali example:</strong> You can create the httpclient config (<a href="https://github.com/salesforce/multicloudj/blob/584f577efd62ecb8f8308cc21c935cc8e0a3c260/sts/sts-ali/src/test/java/com/salesforce/multicloudj/sts/ali/AliStsIT.java#L27">code ref</a>) for the client profile and inject it in the SDK client (<a href="link-to-code">code ref</a>).</p> <h3 id="environment-variables"> <a href="#environment-variables" class="anchor-heading" aria-labelledby="environment-variables"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Environment Variables </h3> <p>Some SDKs support reading the <code class="language-plaintext highlighter-rouge">HTTPS_PROXY</code>, <code class="language-plaintext highlighter-rouge">HTTP_PROXY</code> environment variables if set and direct the API call through the proxy. Examples from Alibaba tablestore <a href="https://github.com/salesforce/multicloudj/blob/584f577efd62ecb8f8308cc21c935cc8e0a3c260/docstore/docstore-ali/src/test/java/com/salesforce/multicloudj/docstore/ali/AliDocstoreIT.java#L37">here</a>.</p> <p>If your SDK is not re-using any of the existing patterns already in the conformance tests, it might take some research on how to inject the custom client.</p> <h2 id="how-to-run-the-java-sdk-conformance-tests-for-alibaba"> <a href="#how-to-run-the-java-sdk-conformance-tests-for-alibaba" class="anchor-heading" aria-labelledby="how-to-run-the-java-sdk-conformance-tests-for-alibaba"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> How to run the Java SDK conformance tests for alibaba </h2> <h3 id="steps"> <a href="#steps" class="anchor-heading" aria-labelledby="steps"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Steps: </h3> <ol> <li> <p>Get the alibaba credentials for authenticating to service as admin preferably unless you want to deal with role based access:</p> <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>acs-sso login <span class="nt">--env</span>
</code></pre></div> </div> </li> <li>Go to your GoLand IDE: <ul> <li>Run â†’ Edit Configurations â†’ Environment. Add the above credentials in the environment: <code class="language-plaintext highlighter-rouge">ALICLOUD_ACCESS_KEY</code>, <code class="language-plaintext highlighter-rouge">ALICLOUD_SECRET_KEY</code> and <code class="language-plaintext highlighter-rouge">ALICLOUD_SECURITY_TOKEN</code> <ul> <li>For docstore: the env variables are: <code class="language-plaintext highlighter-rouge">TABLESTORE_ACCESS_KEY_ID</code>, <code class="language-plaintext highlighter-rouge">TABLESTORE_ACCESS_KEY_SECRET</code> and <code class="language-plaintext highlighter-rouge">TABLESTORE_SESSION_TOKEN</code></li> </ul> </li> <li>In the arguments, add <code class="language-plaintext highlighter-rouge">-Drecord</code></li> </ul> </li> <li> <p>You should be all set to run the tests in record mode.</p> </li> <li>In order to run your tests in replay mode, just remove <code class="language-plaintext highlighter-rouge">-Drecord</code> from Program arguments. Your tests will stop going across the network and will replay from recorded files.</li> </ol> <h2 id="how-to-set-up-the-google-cloud-credentials-in-ide"> <a href="#how-to-set-up-the-google-cloud-credentials-in-ide" class="anchor-heading" aria-labelledby="how-to-set-up-the-google-cloud-credentials-in-ide"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> How to set up the google cloud credentials in IDE </h2> <ol> <li>Login to the gcloud from cli: <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>gcloud auth application-default login
</code></pre></div> </div> </li> <li>Recommended (impersonate the service account and grant all the permissions required to this SA): <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>gcloud config <span class="nb">set </span>auth/impersonate_service_account <span class="nv">$SA_EMAIL</span>
</code></pre></div> </div> </li> <li>Set the <code class="language-plaintext highlighter-rouge">GOOGLE_APPLICATION_CREDENTIALS</code> environment variable pointing to the file with gcp credentials: <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">GOOGLE_APPLICATION_CREDENTIALS</span><span class="o">=</span>/Users/&lt;username&gt;/.config/gcloud/application_default_credentials.json
</code></pre></div> </div> </li> </ol> <h2 id="how-to-run-the-record-mode"> <a href="#how-to-run-the-record-mode" class="anchor-heading" aria-labelledby="how-to-run-the-record-mode"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> How to run the record mode </h2> <p>The tests are configured to take the java system property <code class="language-plaintext highlighter-rouge">-Drecord</code> which will do the recording of the transactions.</p> <p>In intellij for bazel, you can setup this property through Run configurations.</p> <h3 id="note-for-bazel"> <a href="#note-for-bazel" class="anchor-heading" aria-labelledby="note-for-bazel"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Note for Bazel </h3> <p>When running in bazel, your recording path need to be set temporarily to outside the resources directory, and later copied to the resources directory for the module (for example: sts-aws resources directory) once you are done recording. The reason for this is the bazel executing tests in the temporary directory and not the actual path. If you donâ€™t override the recording location, your recordings will be located in that temporary directory for bazel.</p> <p><strong>Tip:</strong> You can setup the root directory to <code class="language-plaintext highlighter-rouge">/tmp</code> which doesnâ€™t need any special write permissions for bazel. Once you run the tests, you should be able to see the <code class="language-plaintext highlighter-rouge">/tmp/mappings</code> directory for the recordings. The equivalent of <code class="language-plaintext highlighter-rouge">-Drecord</code> in bazel will be <code class="language-plaintext highlighter-rouge">--jvmopt="-Drecord"</code></p> <p><strong>Reference command to copy the mappings to bazel path:</strong></p> <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">cp</span> <span class="nt">-r</span> /tmp/mappings /Users/<span class="nv">$relativePath</span>/multicloudj/docstore/docstore-aws/src/test/resources/
</code></pre></div></div> <h3 id="note-for-alibaba-sdk"> <a href="#note-for-alibaba-sdk" class="anchor-heading" aria-labelledby="note-for-alibaba-sdk"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Note for alibaba SDK </h3> <p>Alibaba SDK puts all the secret and dynamic information such as security token, in the URL query params itself instead of headers. This dynamic information creates the problem with replaying because of dynamic nature since the the replayer wonâ€™t be able to find the match with mappings. Wiremock doesnâ€™t provide any clean way to redact the information in the URL. Thus we have to manually change the recorded URL to URL pattern and replace the dynamic information with the wildcards:</p> <p><strong>For example:</strong></p> <p>We change the dynamic information to <code class="language-plaintext highlighter-rouge">.*</code> and changed the key from <code class="language-plaintext highlighter-rouge">url</code> to <code class="language-plaintext highlighter-rouge">urlPattern</code>:</p> <div class="language-json highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nl">"urlPattern"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="s2">"/</span><span class="se">\\</span><span class="s2">?SecurityToken=.*&amp;SignatureVersion=1.0&amp;Action=GetCallerIdentity&amp;Format=JSON&amp;SignatureNonce=.*&amp;Version=2015-04-01&amp;AccessKeyId=.*&amp;Signature=.*&amp;SignatureMethod=HMAC-SHA1&amp;RegionId=cn-shanghai&amp;Timestamp=.*"</span><span class="w">
</span></code></pre></div></div> <h2 id="how-to-run-the-replay-mode"> <a href="#how-to-run-the-replay-mode" class="anchor-heading" aria-labelledby="how-to-run-the-replay-mode"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> How to run the replay mode </h2> <p>If you donâ€™t set up the <code class="language-plaintext highlighter-rouge">-Drecord</code> in the jvmopt, by default the test will run the replay mode and looks for the mappings in the root directory for wiremock.</p> </main> </div> </div> <div class="search-overlay"></div> </div> </body> </html>
